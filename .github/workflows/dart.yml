name: Force Unsigned Build (Final)

on: workflow_dispatch

jobs:
  build_unsigned_force:
    runs-on: macos-latest
    steps:
      # 1. Lấy code về
      - uses: actions/checkout@v3

      # 2. Cài đặt Flutter
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      
      # 3. Tạo cấu trúc iOS
      - name: Create iOS Project
        run: flutter create --platforms=ios .

      # 4. CƯỠNG CHẾ TẮT ĐÒI HỎI TEAM ID (Bước quan trọng nhất)
      # Thay vì chỉ chỉnh Code Sign Style, ta ép biến CODE_SIGNING_ALLOWED = NO
      - name: Nuke Code Signing Logic
        run: |
          cd ios
          # Xóa Team ID
          sed -i '' 's/DEVELOPMENT_TEAM = .*/DEVELOPMENT_TEAM = "";/g' Runner.xcodeproj/project.pbxproj
          # Chuyển về Manual
          sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' Runner.xcodeproj/project.pbxproj
          # Xóa Identity
          sed -i '' 's/CODE_SIGN_IDENTITY = "iPhone Developer";/CODE_SIGN_IDENTITY = "";/g' Runner.xcodeproj/project.pbxproj
          
          # THÊM CỜ: CẤM KÝ TÊN (CODE_SIGNING_ALLOWED = NO) vào mọi cấu hình
          # Lệnh này sẽ tìm dòng 'BuildSettings = {' và chèn dòng cấm ký ngay sau đó
          sed -i '' '/buildSettings = {/a\
          CODE_SIGNING_ALLOWED = NO;\
          CODE_SIGNING_REQUIRED = NO;\
          CODE_SIGN_IDENTITY = "";\
          ' Runner.xcodeproj/project.pbxproj

      - run: flutter pub get

      # 5. Build file .app (Không phải IPA)
      - name: Build iOS App (No Codesign)
        run: |
          # Build App (Chỉ tạo ra folder .app)
          flutter build ios --release --no-codesign

          # Nén thủ công thành IPA để cài qua Scarlet
          mkdir Payload
          # Copy file .app vào Payload
          cp -r build/ios/iphoneos/Runner.app Payload/
          # Nén zip đặt tên đuôi là .ipa
          zip -r Unsigned_Gomoku.ipa Payload

      # 6. Tải file lên
      - name: Upload Unsigned IPA
        uses: actions/upload-artifact@v4
        with:
          name: Gomoku-iOS18-NoSign
          path: Unsigned_Gomoku.ipa
