name: Fix Signing Force Unsigned

on: workflow_dispatch

jobs:
  build_nosign:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      
      # 1. Tạo cấu trúc iOS mặc định
      - name: Init iOS
        run: flutter create --platforms=ios .

      # 2. PATCH (SỬA LỖI): XÓA SẠCH YÊU CẦU TEAM ID TRONG XCODE
      # Chúng ta dùng lệnh 'sed' để xóa các dòng đòi chứng chỉ trong file project.pbxproj
      - name: Remove Signing Requirement
        run: |
          cd ios/Runner.xcodeproj
          # Xóa dòng DevelopmentTeam
          sed -i '' '/DevelopmentTeam/d' project.pbxproj
          # Xóa dòng ProvisioningStyle
          sed -i '' '/ProvisioningStyle/d' project.pbxproj
          # Ép biến CODE_SIGN_IDENTITY thành rỗng
          sed -i '' 's/CODE_SIGN_IDENTITY = "iPhone Developer";/CODE_SIGN_IDENTITY = "";/g' project.pbxproj
          sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' project.pbxproj
          # Quan trọng: Tắt hoàn toàn Code Signing Allowed
          sed -i '' 's/INFOPLIST_KEY_UISupportedInterfaceOrientations =/CODE_SIGNING_ALLOWED = NO; CODE_SIGNING_REQUIRED = NO; CODE_SIGN_IDENTITY = ""; INFOPLIST_KEY_UISupportedInterfaceOrientations =/g' project.pbxproj

      - run: flutter pub get

      # 3. Build iOS App (Dạng .app Folder - ít lỗi hơn build ipa trực tiếp)
      - name: Build .app
        run: |
          flutter build ios --release --no-codesign

      # 4. Đóng gói thủ công thành IPA
      - name: Package as IPA
        run: |
          mkdir Payload
          # Copy file .app đã build vào thư mục Payload
          cp -r build/ios/iphoneos/Runner.app Payload/
          # Nén thành file .ipa
          zip -r Stockfish_Fixed_Unsigned.ipa Payload

      # 5. Upload kết quả
      - name: Download IPA
        uses: actions/upload-artifact@v4
        with:
          name: Gomoku_iOS18_Fixed
          path: Stockfish_Fixed_Unsigned.ipa
