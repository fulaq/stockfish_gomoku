name: GOD TIER - FORCE UNSIGNED BUILD

on: workflow_dispatch

jobs:
  build_force_unsigned:
    name: Build Unsigned IPA (Nuclear Option)
    runs-on: macos-latest
    steps:
      # 1. Lấy mã nguồn về
      - uses: actions/checkout@v3

      # 2. Cài đặt Flutter
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      # 3. Xóa cấu hình cũ & Tạo cấu hình iOS mới tinh
      - name: Clean and Create iOS
        run: |
          rm -rf ios
          flutter create --platforms=ios .

      # 4. [BƯỚC QUAN TRỌNG NHẤT] BẺ KHÓA KÝ TÊN (HACK XCODE PROJECT)
      # Bước này sẽ chạy sau khi tạo dự án để đảm bảo file cấu hình bị can thiệp ngay lập tức
      - name: Disable Signing & Team ID Requirement
        run: |
          cd ios/Runner.xcodeproj
          
          # Xóa dòng Development Team và Provisioning Style
          sed -i '' '/DevelopmentTeam/d' project.pbxproj
          sed -i '' '/ProvisioningStyle/d' project.pbxproj
          
          # Ép các biến hệ thống về chế độ "Không cần ký"
          sed -i '' 's/CODE_SIGN_IDENTITY = "iPhone Developer";/CODE_SIGN_IDENTITY = "";/g' project.pbxproj
          sed -i '' 's/CODE_SIGNING_REQUIRED = "YES";/CODE_SIGNING_REQUIRED = "NO";/g' project.pbxproj
          sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' project.pbxproj
          
          # Chèn cờ cấm ký (CODE_SIGNING_ALLOWED = NO) vào mọi cấu hình Build
          # Dòng này cực mạnh, nó ép Xcode bỏ qua bước kiểm tra Team ID
          sed -i '' '/buildSettings = {/a\
          CODE_SIGNING_ALLOWED = NO;\
          CODE_SIGNING_REQUIRED = NO;\
          CODE_SIGN_IDENTITY = "";\
          ' project.pbxproj

      # 5. Cài thư viện
      - run: flutter pub get

      # 6. Build File App (Không dùng 'build ipa' mà dùng 'build ios' để tránh lỗi)
      - name: Build .app
        run: |
          flutter build ios --release --no-codesign

      # 7. Đóng gói thủ công thành file IPA
      - name: Make Payload and IPA
        run: |
          mkdir Payload
          # Copy thành quả build vào Payload
          cp -r build/ios/iphoneos/Runner.app Payload/
          # Nén zip và đặt đuôi là .ipa
          zip -r Gomoku_God_Tier.ipa Payload

      # 8. Xuất bản phẩm
      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: Gomoku-GodTier-Unsigned
          path: Gomoku_God_Tier.ipa
